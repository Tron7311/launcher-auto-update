name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_CONFIGURATION_TYPES=Release

    - name: Build Release
      run: |
        cd build
        cmake --build . --config Release --verbose

    - name: Find Executable
      run: |
        echo "=== Searching for LauncherApp.exe ==="
        where /r build LauncherApp.exe
        dir /s /b build\LauncherApp.exe
        echo "=== Listing build directory structure ==="
        tree build /F

    - name: Copy Executable to Release Assets
      run: |
        mkdir release-assets
        for /r build %%f in (LauncherApp.exe) do (
          echo Found: %%f
          copy "%%f" "release-assets\LauncherApp.exe"
        )
        dir release-assets

    - name: Create Release with Executable
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/LauncherApp.exe
        body: |
          ## Release ${{ github.ref_name }}
          
          ### Features
          - GitHub-based auto-update system
          - SHA256 hash verification
          - Configuration file support
          
          ### Installation
          1. Download LauncherApp.exe from Assets below
          2. Extract to desired location
          3. Run LauncherApp.exe
          
          ### System Requirements
          - Windows 10 or later
          - Visual Studio C++ Runtime
          
          ### What's Included
          - launcher-auto-update source code
          - GitHub Actions CI/CD pipeline
          - Professional documentation
          - Automated release system
          
          ### Changelog
          See CHANGELOG.md for detailed changes.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
